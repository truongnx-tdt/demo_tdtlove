import*as THREE from"three";import{Text}from"troika-three-text";import{OBJLoader}from"three/examples/jsm/loaders/OBJLoader";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls";import TWEEN from"@tweenjs/tween.js";class ParticleEffect{constructor(){this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.particles=[],this.mouseTrail=[],this.mousePosition=new THREE.Vector2,this.messages=["Xuân Trường","TDT DEV LOVE","Em xinh gái ơi","Anh yêu em","Dev love","TDT DEV"],this.currentMessageIndex=0,this.textPositions=[{y:4,scale:1.2},{y:3,scale:1.1},{y:2,scale:1},{y:1,scale:.9},{y:0,scale:.8},{y:-1,scale:.7},{y:-2,scale:.6},{y:-3,scale:.5}],this.activeTexts=[],this.autoScrollInterval=null,this.scrollSpeed=1500,this.generateInterval=2e3,this.colors=[new THREE.Color(16738740),new THREE.Color(16716947),new THREE.Color(16758465),new THREE.Color(16761035)],this.currentColorIndex=0,this.backgroundColors=[new THREE.Color(16777215),new THREE.Color(16770273),new THREE.Color(16773365),new THREE.Color(16761035)],this.sounds={background:new Audio("/storage/musics/message.mp3")},this.sounds.background.volume=.3,this.sounds.background.loop=!0,this.isPlaying=!1,this.init()}init(){this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),document.getElementById("app").appendChild(this.renderer.domElement),this.camera.position.x=-10,this.camera.position.z=12,this.controls=new OrbitControls(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.autoRotate=!1,this.controls.enableZoom=!1,this.controls.minPolarAngle=Math.PI/2,this.controls.maxPolarAngle=Math.PI/2,this.controls.enablePan=!1;const t=new THREE.AmbientLight(16777215,.7);this.scene.add(t);const e=new THREE.DirectionalLight(16777215,.8);e.position.set(1,1,1),this.scene.add(e);const o=new THREE.PointLight(15623846,1.5,15);o.position.set(2,2,2),this.scene.add(o);(new OBJLoader).load("/storage/heart.obj",(t=>{const e=(new THREE.Box3).setFromObject(t).getCenter(new THREE.Vector3),o=new THREE.Group;t.position.sub(e),o.add(t),o.scale.set(.02,.02,.02),o.position.y=0,t.rotation.x=-Math.PI/2,t.rotation.y=0,t.traverse((t=>{t instanceof THREE.Mesh&&(t.material=new THREE.MeshPhongMaterial({color:16738740,shininess:100,specular:16777215}))})),this.scene.add(o),this.heart=o,this.setupHeartAnimation()})),this.createParticles(),this.createMouseTrail(),this.startTextGeneration(),window.addEventListener("resize",(()=>this.onWindowResize()),!1),window.addEventListener("mousemove",(t=>this.onMouseMove(t))),window.addEventListener("click",(()=>{this.autoScrollInterval?this.stopAutoScroll():this.startAutoScroll()})),window.addEventListener("click",(()=>{this.startBackgroundMusic()}),{once:!0}),this.startAutoScroll(),this.animate()}createMouseTrail(){const t=new THREE.BufferGeometry,e=new THREE.PointsMaterial({size:.05,color:15623846,transparent:!0,opacity:.8}),o=new Float32Array(150);t.setAttribute("position",new THREE.BufferAttribute(o,3)),this.mouseTrail=new THREE.Points(t,e),this.scene.add(this.mouseTrail)}onMouseMove(t){this.mousePosition.x=t.clientX/window.innerWidth*2-1,this.mousePosition.y=-t.clientY/window.innerHeight*2+1;const e=this.mouseTrail.geometry.attributes.position.array;for(let t=e.length-3;t>0;t-=3)e[t]=e[t-3],e[t+1]=e[t-2],e[t+2]=e[t-1];const o=new THREE.Vector3(this.mousePosition.x,this.mousePosition.y,.5);o.unproject(this.camera);const i=o.sub(this.camera.position).normalize(),s=-this.camera.position.z/i.z,n=this.camera.position.clone().add(i.multiplyScalar(s));e[0]=n.x,e[1]=n.y,e[2]=n.z,this.mouseTrail.geometry.attributes.position.needsUpdate=!0}setupHeartAnimation(){if(!this.heart)return;const t=.5/60;let e=0,o=0,i=0,s=0;let n=[],r=0;this.heart.position.y=-o;const a=()=>{for(i+=t,r+=t,o=0*i-9+1*i*i,e=0+2*i,this.heart.position.y=-o,this.heart.rotation.z=.3*Math.sin(4*i),this.heart.rotation.x=.2*Math.cos(3*i),this.heart.rotation.y=3*i;s<100;){const t=this.heart.clone(),e=30*(Math.random()-.5),o=20*(Math.random()-.5),i=-15,r=i+Math.random()*(15-i),a={object:t,velocity:0,position:r,gravity:2+.5*Math.random(),startX:e,startZ:o};t.position.set(e,r,o),this.scene.add(t),n.push(a),s++}r>=2&&(this.generateNewText(),r=0),n.forEach(((e,o)=>{e.velocity+=e.gravity*t,e.position+=e.velocity*t,e.object.position.y=-e.position,e.object.rotation.z=.3*Math.sin(4*i),e.object.rotation.x=.2*Math.cos(3*i),e.object.rotation.y=3*i,e.position>10&&(e.position=5*Math.random()-15,e.velocity=0,e.object.position.x=e.startX,e.object.position.z=e.startZ)})),this.activeTexts.forEach(((e,o)=>{e.velocity+=e.gravity*t,e.position+=e.velocity*t,e.object.position.y=-e.position,e.object.rotation.z=.1*Math.sin(4*i),e.position>10&&(e.position=5*Math.random()-15,e.velocity=0,e.object.position.x=e.startX,e.object.position.z=e.startZ)})),requestAnimationFrame(a)};a()}startAutoScroll(){this.autoScrollInterval||(this.autoScrollInterval=setInterval((()=>this.cycleMessage()),this.scrollSpeed))}stopAutoScroll(){this.autoScrollInterval&&(clearInterval(this.autoScrollInterval),this.autoScrollInterval=null)}cycleMessage(){}getOpacityForPosition(t){const e=(t+2)/4;return.4+.6*(1-2*Math.abs(e-.5))}createParticles(){const t=1e3,e=new THREE.BufferGeometry,o=new Float32Array(3e3),i=new Float32Array(3e3),s=new Float32Array(3e3);for(let e=0;e<t;e++){o[3*e]=0,o[3*e+1]=0,o[3*e+2]=0;const t=Math.random()*Math.PI*2,n=Math.acos(2*Math.random()-1),r=.02+.01*Math.random();s[3*e]=Math.sin(n)*Math.cos(t)*r,s[3*e+1]=Math.sin(n)*Math.sin(t)*r,s[3*e+2]=Math.cos(n)*r;this.colors[0];i[3*e]=255,i[3*e+1]=255,i[3*e+2]=255}e.setAttribute("position",new THREE.BufferAttribute(o,3)),e.setAttribute("color",new THREE.BufferAttribute(i,3)),e.setAttribute("velocity",new THREE.BufferAttribute(s,3));const n=new THREE.PointsMaterial({size:.05,vertexColors:!0,transparent:!0,opacity:.7}),r=new THREE.Points(e,n);this.scene.add(r),this.particles.push(r)}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){requestAnimationFrame((()=>this.animate())),TWEEN.update(),this.controls.enabled&&this.controls.update(),this.particles.forEach((t=>{const e=t.geometry.attributes.position.array,o=t.geometry.attributes.velocity.array;for(let t=0;t<e.length;t+=3){e[t]+=o[t],e[t+1]+=o[t+1],e[t+2]+=o[t+2];if(Math.sqrt(e[t]*e[t]+e[t+1]*e[t+1]+e[t+2]*e[t+2])>10){e[t]=0,e[t+1]=0,e[t+2]=0;const i=Math.random()*Math.PI*2,s=Math.acos(2*Math.random()-1),n=.02+.01*Math.random();o[t]=Math.sin(s)*Math.cos(i)*n,o[t+1]=Math.sin(s)*Math.sin(i)*n,o[t+2]=Math.cos(s)*n}}t.geometry.attributes.position.needsUpdate=!0})),this.activeTexts.forEach(((t,e)=>{Math.abs(t.velocity)<.01&&(t.velocity=.1),t.velocity+=t.gravity*(.25/60),t.position+=t.velocity*(.25/60),t.object.position.y=-t.position,t.object.rotation.z=.1*Math.sin(.001*Date.now()+e);const o=(t.position+18)/28,i=[{r:255,g:255,b:255},{r:255,g:200,b:200},{r:255,g:100,b:100},{r:255,g:0,b:0}];let s=Math.floor(o*(i.length-1)),n=o*(i.length-1)%1,r=i[s],a=i[Math.min(s+1,i.length-1)];const c=`rgb(${Math.round(r.r+(a.r-r.r)*n)}, ${Math.round(r.g+(a.g-r.g)*n)}, ${Math.round(r.b+(a.b-r.b)*n)})`;t.object.color=c,t.object.outlineColor=c,t.object.outlineWidth=.02,t.object.font="/font/pacifico/Pacifico-Regular.ttf",t.object.fontFamily="Pacifico, Arial, sans-serif",t.object.fontWeight="normal",t.object.fontStyle="normal",t.object.characterSet="latin, symbols",t.object.direction="ltr",t.object.whiteSpace="normal",t.object.letterSpacing=0,t.object.lineHeight=1,t.object.textAlign="center",t.object.textBaseline="middle",t.object.allowMultipleFonts=!0,t.object.material.uniforms&&(t.object.material.uniforms.time.value=.001*Date.now());const l=.5+.5*Math.sin(.001*Date.now()+e);t.object.material.opacity=.8+.2*l,t.object.sync(),t.position>10&&(t.position=3*Math.random()-18,t.velocity=.1,t.object.position.x=t.startX,t.object.position.z=t.startZ)})),this.heart&&(this.heart.rotation.y+=.005),this.mouseTrail&&(this.mouseTrail.rotation.x+=.001,this.mouseTrail.rotation.y+=.001),this.renderer.render(this.scene,this.camera)}startTextGeneration(){this.activeTexts.forEach((t=>{this.scene.remove(t),t.dispose()})),this.activeTexts=[];for(let t=0;t<10;t++)setTimeout((()=>{this.generateNewText()}),300*t);this.generateInterval&&clearInterval(this.generateInterval),this.generateInterval=setInterval((()=>{this.generateNewText()}),2e3)}generateNewText(){const t=new Text;t.text=this.messages[this.currentMessageIndex],t.fontSize=.5,t.color="#FFFFFF",t.outlineColor="#FFFFFF",t.outlineWidth=.02,t.material.opacity=.95,t.anchorX="center",t.anchorY="middle",t.overflowWrap="break-word",t.maxWidth=8,t.font="/font/pacifico/Pacifico-Regular.ttf",t.fontFamily="Pacifico, Arial, sans-serif",t.fontWeight="normal",t.fontStyle="normal",t.characterSet="latin, symbols",t.direction="ltr",t.whiteSpace="normal",t.letterSpacing=0,t.lineHeight=1,t.textAlign="center",t.textBaseline="middle",t.allowMultipleFonts=!0,t.material.onBeforeCompile=t=>{t.uniforms.time={value:0},t.fragmentShader=t.fragmentShader.replace("#include <color_fragment>","\n                #include <color_fragment>\n                float glow = 0.5 + 0.5 * sin(vUv.x * 10.0 + time * 2.0);\n                float pulse = 0.5 + 0.5 * sin(time * 3.0);\n                vec3 glowColor = vec3(1.0, 0.8, 0.8); // Soft pink glow\n                diffuseColor.rgb += glowColor * glow * pulse * 0.3;\n                diffuseColor.rgb = mix(diffuseColor.rgb, glowColor, glow * pulse * 0.2);\n                ")},t.sync();const e=30*(Math.random()-.5),o=16*(Math.random()-.5),i=3*Math.random()-18;t.position.set(e,i,o),t.scale.setScalar(.8);const s={object:t,velocity:.1,position:i,gravity:.35+.1*Math.random(),startX:e,startZ:o};this.scene.add(t),this.activeTexts.push(s),this.currentMessageIndex=(this.currentMessageIndex+1)%this.messages.length,this.currentColorIndex=(this.currentColorIndex+1)%this.colors.length}startBackgroundMusic(){this.sounds.background.play().then((()=>{console.log("Background music started")})).catch((t=>{console.log("Background music failed to start:",t)}))}}new ParticleEffect;